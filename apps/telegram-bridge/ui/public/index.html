<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Telegram Bridge Settings</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
      .card { max-width: 820px; padding: 1.25rem 1.5rem; border: 1px solid #e5e7eb; border-radius: 8px; }
      label { display:block; margin-top: 1rem; font-weight: 600; }
      input { width: 100%; padding: 0.5rem; margin-top: 0.25rem; }
      button { margin-top: 1rem; padding: 0.5rem 0.8rem; }
      .row { display:flex; gap: 0.5rem; align-items: center; }
      .hint { color:#555; font-size: 0.9rem; }
      .success { color: #0a7f3f; }
      .error { color: #b00020; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Telegram Bridge Settings</h1>
      <p class="hint">Use Tailscale MagicDNS/IP for the appservice URL, e.g., <code>http://umbrel.&lt;tailnet&gt;.ts.net:29317</code> or <code>http://100.x.y.z:29317</code>.</p>

      <div class="row">
        <div style="flex:1">
          <label>Homeserver address (client URL)</label>
          <input id="homeserverAddress" placeholder="http://synapse.example.com:8008" />
        </div>
        <div>
          <button id="validate">Validate</button>
        </div>
      </div>

      <label>Matrix domain</label>
      <input id="matrixDomain" placeholder="example.com" />

      <label>Appservice address (Synapse → bridge)</label>
      <input id="appserviceAddress" placeholder="http://umbrel.<tailnet>.ts.net:29317" />
      <div class="hint" id="prefillHint"></div>

      <div class="row">
        <div style="flex:1">
          <label>HS token</label>
          <input id="hsToken" placeholder="auto-generate or paste" />
        </div>
        <div style="flex:1">
          <label>AS token</label>
          <input id="asToken" placeholder="auto-generate or paste" />
        </div>
        <div>
          <button id="genTokens">Generate tokens</button>
        </div>
      </div>

      <label>Bot username</label>
      <input id="botUsername" placeholder="telegrambot" />

      <div>
        <button id="save">Save Config</button>
        <span id="msg"></span>
      </div>

      <div id="restartTip" class="hint" style="display:none; margin-top: 0.5rem;">
        Saved. Please restart the app from Umbrel for changes to take effect.
      </div>

      <hr />
      <p class="hint">After saving, restart the app and generate the registration file inside the bridge container:</p>
      <pre>
docker exec -it telegram-bridge sh -lc "mautrix-telegram -g -c /data/config.yaml -r /data/registration.yaml"
      </pre>
      <p class="hint">Then add the registration to Synapse and restart it. See Integration docs.</p>
    </div>

    <script>
      const $ = (id) => document.getElementById(id)
      const msg = (text, cls) => { const el = $("msg"); el.textContent = text; el.className = cls || "" }

      async function load() {
        try {
          const r = await fetch('/api/config')
          const j = await r.json()
          if (j?.values) {
            $('homeserverAddress').value = j.values.homeserverAddress || ''
            $('matrixDomain').value = j.values.matrixDomain || ''
            $('appserviceAddress').value = j.values.appserviceAddress || ''
            $('hsToken').value = j.values.hsToken || ''
            $('asToken').value = j.values.asToken || ''
            $('botUsername').value = j.values.botUsername || ''
          }
        } catch (e) {}

        // Prefill appservice if empty and server provided a default host
        try {
          const r2 = await fetch('/api/meta')
          const j2 = await r2.json()
          if (j2?.defaultAppserviceHost && !$('appserviceAddress').value) {
            const host = j2.defaultAppserviceHost
            $('appserviceAddress').value = `http://${host}:29317`
            $('prefillHint').textContent = `Prefilled from DEFAULT_APPSERVICE_HOST: ${host}`
          }
        } catch (e) {}
      }

      function rnd(len=48) {
        const alphabet = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
        let s = ''
        for (let i=0;i<len;i++) s += alphabet[Math.floor(Math.random()*alphabet.length)]
        return s
      }

      $('genTokens').onclick = () => {
        $('hsToken').value = rnd(64)
        $('asToken').value = rnd(64)
      }

      $('save').onclick = async () => {
        msg('Saving...', '')
        const payload = {
          homeserverAddress: $('homeserverAddress').value.trim(),
          matrixDomain: $('matrixDomain').value.trim(),
          appserviceAddress: $('appserviceAddress').value.trim(),
          hsToken: $('hsToken').value.trim(),
          asToken: $('asToken').value.trim(),
          botUsername: $('botUsername').value.trim() || 'telegrambot'
        }
        try {
          const r = await fetch('/api/config', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify(payload) })
          const j = await r.json()
          if (j.ok) { msg('Saved.', 'success'); $('restartTip').style.display = 'block' }
          else msg(j.error || 'Failed', 'error')
        } catch (e) {
          msg('Failed to save', 'error')
        }
      }

      $('validate').onclick = async () => {
        msg('Validating...', '')
        const payload = {
          homeserverAddress: $('homeserverAddress').value.trim(),
          matrixDomain: $('matrixDomain').value.trim()
        }
        try {
          const r = await fetch('/api/validate', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify(payload) })
          const j = await r.json()
          if (!j.ok) return msg(j.error || 'Validation failed', 'error')
          const parts = []
          if (j.results?.versions?.ok) parts.push('versions OK')
          else parts.push(`versions ERR (${j.results?.versions?.status || 'n/a'})`)
          if (payload.matrixDomain) {
            if (j.results?.wellKnown?.ok) parts.push('well-known OK')
            else parts.push('well-known ERR')
          }
          msg(parts.join(' · '), (j.results?.versions?.ok ? 'success' : 'error'))
        } catch (e) {
          msg('Validation failed', 'error')
        }
      }

      load()
    </script>
  </body>
  </html>
